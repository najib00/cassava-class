<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tensorflow Cassava Disease Image Classification</title>
	<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs/dist/tf.min.js"> </script>
	<script src = "http://www.myersdaily.org/joseph/javascript/md5.js">
	</script>
<style>
#image {
	width: 300px;
}
	.bold {
		font-weight: bold;
	}

</style>
</head>
<body>
	<input type="file" id="uploadbutton"></file>
	<h3 id ="result"></h3>
	<div>
	<img style="float: left;" id="image"></img>
	<div style="float: left;">
		<ul>
			<li>Healthy: <span id="healthy"></span></li>
			<li>CBB: <span id="cbb"></span></li>
			<li>CBSD: <span id="cbsd"></span></li>
			<li>CGM: <span id="cgm"></span></li>
			<li>CMD: <span id="cmd"></span></li>
		</ul>
	</div>
	</div>

	<script>
let labels = ["CBB", "CBSD", "CGM", "CMD", "Healthy"]
let labelElement = [
	document.getElementById("cbb"),
	document.getElementById("cbsd"),
	document.getElementById("cgm"),
	document.getElementById("cmd"),
	document.getElementById("healthy"),
]
let resultLabel = document.getElementById("result")
let uploadButton = document.getElementById("uploadbutton")
let image = document.getElementById("image")
let tfmodel = false
let updateValues = (val) => {
	if (!Array.isArray(val)) {
		val = [0,0,0,0,0]
	}
	val.forEach(function (v, i) { if (labelElement[i]) labelElement[i].innerHTML = v })
}
let predict = async function () {
	tfmodel = tfmodel || await tf.loadLayersModel("model/keras_tfjs/model.json")
	let imageTensor = tf.browser.fromPixels(image)
	console.log(md5(image.src))
	console.log("Image Size" + imageTensor.shape)
	let tensorResized = tf.image.resizeNearestNeighbor(imageTensor, [224, 224]).expandDims()
	console.log("Image resized " + tensorResized.shape)

	let prediction = await tfmodel.predict(tensorResized)
	updateValues(prediction.arraySync()[0])
	let result = prediction.argMax(1).arraySync()
	resultLabel.innerHTML = "Disease: " + labels[result[0]]
}
uploadButton.addEventListener("change", function (e) {
	if (uploadButton.files && uploadButton.files[0]) {
		resultLabel.innerHTML = ""
		updateValues()
		let reader = new FileReader()
		reader.onload = function (e) {
			image.src = e.target.result;
			predict()
		}
		reader.readAsDataURL(uploadButton.files[0])
	}
})
	</script>
</body>
</html>
